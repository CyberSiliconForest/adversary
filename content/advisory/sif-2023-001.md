---
title: "SIF-2023-001"
date: 2023-10-10T10:06:48+09:00
draft: false
---

## Description
Denial of Service attack through Mastodon HTTP signature validation.

## Affected software / version
All currently supported Mastodon version (suspects)



## Severity
CVSS v3.1 score: 7.5 (High)

Vector String: `AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H`

## Detailed information
When Mastodon has to verify the actor is eligible to fetch the status,
Mastodon parses the request header and

* Tries to retrieve the signing key from the remote actor
* Validate the actor through Webfinger request

During this process, maliciously crafted servers intentionally delay
communication to the victim server and can hold the connection for
up to 20 seconds by delaying both responses right before timeout.

An attacker can leverage this to fill up the web pool. It directly
leads to the slowloris-type denial-of-service attack.

## Proof-of-Concept code
[ RESTRICTED INFORMATION ]

## Possible mitigation
### Mastodon server administrators

No full mitigation exists. only partial ones.

* Disable `AUTHORIZED_FETCH`. This will disable the HTTP signature
  validation on public resources.

Note that this will only make the attack harder, not impossible.

You will still be vulnerable to requests pointing to the following resources

* shared inbox
* user inbox
* private posts (followers only, mentioned peoples only)

### Mastodon code maintainers
* Validate actor eligibility through key ID before fetching the key
* Rate limit the number of actor creation per public suffix
* Apply concurrent connection limit per IP address on ActivityPub requests
  (may problematic on communication between large instances)
* Reduce the timeout value (not recommended)

... or to fix it fundermentally (and gain extra performance boost) ...

* Heavily modify RoR and its dependency to somehow make the HTTP signature
  validation process asynchronous.
* [RIIR](https://github.com/ansuz/RIIR)
* OK, at least, rewrite it in a language that supports asynchronous I/O well.

## Notes
This attack scenario also can happen in normal situations. It is much like a
performance issue rather then proper "vulnerability" but severe enough to make
it a vulnerability.

For example, if one server A decides to cease operation and runs self-destruct
script, it will

* Spam `DELETE` activity to all servers that it knows.

A relatively new server B that does not know lots of accounts of the server A
will try to validate the HTTP request it received in the `/inbox` endpoint.

It will

* Attempt to fetch the signing key from the remote server A
* Attempt to validate the actor through Webfinger request to server A

And if the server A is not responding, it will wait for the timeout (up to 10
sec for each sub-operation)

If the server A sends lots of `DELETE` activities but struggles to answer the
key request fast enough, it will eventually fill up the web pool of server B
and make it unresponsive.

## References
N/A

## Disclosure timeline
| Timestamp         | Comment                                                                            |
|-------------------|------------------------------------------------------------------------------------|
| 2023-07-19T01:00Z | Exploit idea emerged.                                                              |
| 2023-07-19T13:00Z | First Proof-of-Concept developed and tested against Mastodon 4.1.2                 |
| 2023-07-19T14:23Z | Proof-of-Concept tested against 4.1.3                                              |
| 2023-07-20T09:36Z | Report written and sent to security@joinmastodon.org                               |
| 2023-07-20T09:54Z | File proof published at https://social.silicon.moe/@perillamint/110745803938940887 |
| 2023-08-05T10:55Z | Contacted again through security@joinmastodon.org                                  |
| 2023-08-08T03:01Z | Received acknowledgement from Mastodon gGmbH                                       |
| 2023-09-19T20:23Z | Sent reminder email to security@joinmastodon.org (No response yet)                 |
| 2023-10-18T09:36Z | Responsible disclusure deadline                                                    |
| 2023-10-18T10:00Z | Public disclosure                                                                  |
